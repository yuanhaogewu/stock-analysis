# A股专业股票分析工具 - 核心开发手册

本手册是本套“A股AI分析系统”的核心技术文档。其目的是帮助开发者在最短时间内理解本项目的开发语言、程序架构以及最关键的内容生成逻辑。

---

## 1. 核心架构概览 (System Architecture)

本项目采用**前后端分离**的全栈架构，设计上强调“高响应性”与“金融级视觉体验”。

- **前端 (Frontend)**: 基于 **Next.js (React)** 的 App Router 模式。利用 Server Component 提供 SEO 优化，Client Component 处理高频交互。
- **后端 (Backend)**: 基于 **FastAPI (Python)**。采用异步 IO 处理个股行情抓取与 AI 诊断任务。
- **数据流**: 前端通过 REST API 与后端通信，后端动态对接 **AkShare** 指标引擎与 **DeepSeek** 大模型接口。

---

## 2. 技术栈说明 (Tech Stack)

### 2.1 开发语言与框架
- **后端**: Python 3.10+ (FastAPI, Pandas, Httpx)
- **前端**: TypeScript + React 18 (Next.js 14)
- **样式**: 原生 CSS (Vanilla CSS)，遵循毛玻璃 (Glassmorphism) 与暗色金融视觉规范。
- **数据库**: SQLite3 (使用轻量级本地文件存储配置与用户信息)。

### 2.2 核心依赖
- **行情引擎**: `akshare`（用于抓取 A 股实时排行榜、个股 K 线、指数数据）。
- **图表系统**: `ECharts`（定制化的 K 线图、MACD 指标以及技术信号标注）。
- **AI 交互**: `httpx`（异步处理大模型 API 请求）。

---

## 3. 核心内容生成逻辑 (Core Content Logic)

这是本系统的灵魂，主要体现在“AI 诊断引擎”与“本地备份逻辑”的协同。

### 3.1 结构化诊断逻辑 (AI Diagnosis)
后端 `get_deepseek_analysis` 函数并非简单的聊天接口，它遵循以下生成链路：
1. **数据采样**: 提取个股最新价格、指标（PE/PB/ROE）、以及最近 30 个交易日的 K 线序列。
2. **逻辑约束**: 通过增强的系统提示词（System Prompt），强制 AI 将分析结构化为 JSON。
3. **内容审计**: 
   - **去专业化**: 核心结论必须被翻译为“股市新手”能秒懂的民间口语（如：使用“上涨势头很猛”而非“趋势多头”）。
   - **禁止后验**: 明确禁止 AI 对过去的价格标注“买/卖”点，仅允许标注具有逻辑解释力的“技术洞察”点（💡 信号）。

### 3.2 本地规则探测引擎 (Fallback Engine)
当 AI 接口超时或 API Key 失效时，后端会自动切换至本地规则：
- 基于 **MA20 均线系统** 与 **量比波动** 进行动态得分计算。
- 自动生成符合 AI 语境的“模拟推演”结论，确保用户体验不中断。

### 3.3 会员等级与数据脱敏逻辑 (VIP & Censorship)
系统对“AI 智能分析报告”版块实施了精细化的权限控制：
- **VIP 会员 (含7天试用期)**：通过后端审核的到期时间判断，展示由 DeepSeek 生成的完整深度分析。
- **普通会员 (已到期)**：
  - 系统仍展示分析版块和基础指标。
  - 核心分析结论（advice, detail_advice）及结构化分析细节（structured_analysis）会被 **mask_vip 函数** 动态脱敏。
  - 脱敏后的内容以星号代替并提示 `*** VIP 会员可查看`。
  - **性能优化**：对于已过期用户，后端会自动跳过高成本的 AI 接口调用，直接利用本地引擎生成脱敏骨架数据。

---

## 4. 关键业务逻辑与实现细节

### 4.1 日期时间兼容性
系统内所有日期比较（如校验 VIP 是否到期）均采用 **Naive Datetime** 转换逻辑：
- 强制剥离 ISO 字符串中的时区信息（T/Z），确保 SQLite 的字符串存储与 Python `datetime.now()` 能够安全对比，防止系统崩溃。

### 4.2 全局权限拦截 (ClientLayout)
前端使用 `src/components/ClientLayout.tsx` 作为全局守卫：
- 动态监听 `localStorage` 中的用户 Token。
- 对诊股、支付等二级页面进行强拦截，未登录用户自动重定向至登录页。

### 4.3 数据库模型
- **users 表**: 核心字段 `expires_at` (账号有效期) 以及自动生成的 `referral_code` (邀请码)。新注册用户默认写入 `now + 7 days` 作为试用期限。新增 `avatar` 字段用于存储用户自定义头像。
- **system_config 表**: 采用 KV 结构存储，支持管理员后台实时修改 AI Key、平台 LOGO、收款码及公告内容。

### 4.4 个人资料修改逻辑 (Profile Management)
系统支持用户自主修改个人信息：
- **入口**: 点击侧边栏底部的用户头像或姓名即可打开个人资料编辑弹窗。
- **功能**: 支持修改显示姓名（username）、上传头像（利用 `/api/upload` 接口）以及修改登录密码。
- **安全**: 修改密码需提供原密码进行校验。更新成功后，系统会同步更新后端数据库及前端 `localStorage` 缓存。

### 4.5 公告系统的 Markdown 渲染
平台公告在前端采用了自定义的轻量级解析引擎：
- **服务端存储**: 公告以纯文本格式存储。
- **前端解析**: 在 `ClientLayout.tsx` 中通过正则替换实现对 `#` (标题)、`**` (加粗)、`-` (列表)、`>` (引用) 及 `code` (行内代码) 的实时渲染，无需依赖沉重的第三方 Markdown 库。

---

## 5. 开发规范与美学准则

- **命名规范**: 代码内标识符采用全英文。
- **UI 风格**: 
  - 背景：深蓝至紫色的微渐变 (`var(--bg-card)`)。
  - 卡片：支持 `backdrop-filter: blur(12px)` 的半透明质感。
  - 动态：所有交互按钮必须具备 `scale(1.02)` 的 Hover 缩放反馈。
- **回复语言**: 最终面向用户的 UI 字符串与 AI 生成内容必须为 **简体中文**。

---
*本手册专注于开发逻辑，不包含环境部署及复现细节。*
